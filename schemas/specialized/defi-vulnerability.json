{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://ai-blockchain-analytics.com/schemas/defi-vulnerability.json",
  "title": "DeFi-Specific Vulnerability Finding",
  "description": "Extended schema for DeFi protocol vulnerability findings",
  "allOf": [
    {
      "$ref": "../vulnerability-finding-schema.json"
    }
  ],
  "properties": {
    "defi_context": {
      "type": "object",
      "description": "DeFi-specific context and metadata",
      "properties": {
        "protocol_type": {
          "type": "string",
          "enum": [
            "DEX",
            "LENDING",
            "STAKING", 
            "YIELD_FARMING",
            "SYNTHETIC_ASSETS",
            "DERIVATIVES",
            "INSURANCE",
            "CROSS_CHAIN_BRIDGE",
            "ALGORITHMIC_STABLECOIN",
            "LIQUID_STAKING",
            "PERPETUAL_FUTURES",
            "OPTIONS_PROTOCOL",
            "PREDICTION_MARKET"
          ]
        },
        "tvl_at_risk": {
          "type": "object",
          "properties": {
            "amount_usd": {
              "type": "number",
              "minimum": 0,
              "description": "Total Value Locked at risk in USD"
            },
            "percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Percentage of total TVL at risk"
            },
            "affected_pools": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of affected liquidity pools"
            }
          }
        },
        "flash_loan_exploitable": {
          "type": "boolean",
          "description": "Whether vulnerability can be exploited using flash loans"
        },
        "mev_exploitable": {
          "type": "boolean", 
          "description": "Whether vulnerability enables MEV extraction"
        },
        "arbitrage_risk": {
          "type": "object",
          "properties": {
            "cross_dex": {
              "type": "boolean"
            },
            "price_manipulation": {
              "type": "boolean"
            },
            "slippage_attack": {
              "type": "boolean"
            }
          }
        },
        "oracle_dependency": {
          "type": "object",
          "properties": {
            "oracle_type": {
              "type": "string",
              "enum": ["CHAINLINK", "UMA", "BAND", "UNISWAP_TWAP", "CUSTOM", "NONE"]
            },
            "manipulation_risk": {
              "type": "string",
              "enum": ["HIGH", "MEDIUM", "LOW", "NONE"]
            },
            "single_point_failure": {
              "type": "boolean"
            }
          }
        },
        "liquidity_risks": {
          "type": "object",
          "properties": {
            "impermanent_loss": {
              "type": "boolean"
            },
            "liquidity_drain": {
              "type": "boolean"
            },
            "sandwich_attack": {
              "type": "boolean"
            },
            "front_running": {
              "type": "boolean"
            }
          }
        },
        "governance_risks": {
          "type": "object",
          "properties": {
            "admin_key_risk": {
              "type": "boolean"
            },
            "upgrade_risk": {
              "type": "boolean"
            },
            "time_lock_bypass": {
              "type": "boolean"
            },
            "vote_manipulation": {
              "type": "boolean"
            }
          }
        },
        "cross_chain_risks": {
          "type": "object",
          "properties": {
            "bridge_dependency": {
              "type": "boolean"
            },
            "chain_reorganization": {
              "type": "boolean"
            },
            "validator_collusion": {
              "type": "boolean"
            }
          }
        }
      },
      "required": ["protocol_type"],
      "additionalProperties": false
    },
    "economic_impact": {
      "type": "object",
      "description": "Economic impact analysis for DeFi protocols",
      "properties": {
        "market_impact": {
          "type": "object",
          "properties": {
            "token_price_impact": {
              "type": "number",
              "description": "Expected token price impact percentage"
            },
            "liquidity_impact": {
              "type": "string",
              "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "NONE"]
            },
            "ecosystem_contagion": {
              "type": "boolean",
              "description": "Risk of spreading to other protocols"
            }
          }
        },
        "user_funds": {
          "type": "object",
          "properties": {
            "direct_loss": {
              "type": "number",
              "description": "Direct user fund loss in USD"
            },
            "affected_users": {
              "type": "integer",
              "minimum": 0
            },
            "recovery_possible": {
              "type": "boolean"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "attack_vectors": {
      "type": "object",
      "description": "DeFi-specific attack vectors",
      "properties": {
        "flash_loan_attack": {
          "type": "object",
          "properties": {
            "feasible": {
              "type": "boolean"
            },
            "required_capital": {
              "type": "number",
              "description": "Minimum capital required in USD"
            },
            "profit_potential": {
              "type": "number",
              "description": "Potential profit in USD"
            }
          }
        },
        "governance_attack": {
          "type": "object",
          "properties": {
            "token_requirement": {
              "type": "number",
              "description": "Percentage of tokens needed for attack"
            },
            "time_to_execute": {
              "type": "string",
              "description": "Time needed to execute governance attack"
            }
          }
        },
        "oracle_manipulation": {
          "type": "object",
          "properties": {
            "manipulation_cost": {
              "type": "number",
              "description": "Cost to manipulate oracle in USD"
            },
            "duration_needed": {
              "type": "string",
              "description": "How long manipulation must be sustained"
            }
          }
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "id": "DEFI_FLASH_001",
      "severity": "CRITICAL",
      "title": "Flash Loan Price Manipulation in AMM Pool",
      "category": "FLASH_LOAN_ATTACK",
      "subcategory": "Price Oracle Manipulation",
      "description": "The DEX uses its own AMM pool as a price oracle without sufficient protection against flash loan attacks. An attacker can manipulate the pool price within a single transaction to exploit lending protocols that rely on this price feed.",
      "defi_context": {
        "protocol_type": "DEX",
        "tvl_at_risk": {
          "amount_usd": 50000000,
          "percentage": 15.5,
          "affected_pools": ["ETH/USDC", "WBTC/ETH"]
        },
        "flash_loan_exploitable": true,
        "mev_exploitable": true,
        "oracle_dependency": {
          "oracle_type": "UNISWAP_TWAP",
          "manipulation_risk": "HIGH",
          "single_point_failure": true
        },
        "liquidity_risks": {
          "impermanent_loss": false,
          "liquidity_drain": true,
          "sandwich_attack": true,
          "front_running": true
        }
      },
      "economic_impact": {
        "market_impact": {
          "token_price_impact": -25.0,
          "liquidity_impact": "CRITICAL",
          "ecosystem_contagion": true
        },
        "user_funds": {
          "direct_loss": 12000000,
          "affected_users": 1500,
          "recovery_possible": false
        }
      },
      "attack_vectors": {
        "flash_loan_attack": {
          "feasible": true,
          "required_capital": 0,
          "profit_potential": 5000000
        },
        "oracle_manipulation": {
          "manipulation_cost": 100000,
          "duration_needed": "1 block"
        }
      },
      "recommendation": {
        "summary": "Implement Time-Weighted Average Price (TWAP) oracle with sufficient time window and consider using multiple oracle sources",
        "details": "1. Replace spot price oracle with TWAP over minimum 10-minute window\n2. Implement oracle circuit breakers for large price movements\n3. Use multiple price sources (Chainlink + TWAP)\n4. Add slippage protection and maximum transaction limits\n5. Consider implementing commit-reveal schemes for large trades",
        "references": [
          {
            "title": "Oracle Price Manipulation Attacks",
            "url": "https://blog.openzeppelin.com/secure-smart-contract-guidelines-the-dangers-of-price-oracles/",
            "type": "research_paper"
          }
        ]
      },
      "location": {
        "file": "PriceOracle.sol",
        "line": 89,
        "function": "getPrice",
        "contract": "DexPriceOracle"
      },
      "confidence": {
        "level": "HIGH",
        "score": 0.94
      },
      "timestamp": "2024-01-15T14:40:00Z",
      "scanner": {
        "name": "AI Blockchain Analytics",
        "version": "2.1.0",
        "scan_id": "scan_defi_001"
      }
    }
  ]
}
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://blockchain-analytics.com/schemas/security-finding-v5.json",
  "title": "Security Finding Schema v5.0 - AI-Optimized OWASP Style",
  "description": "Comprehensive JSON schema for AI-powered smart contract security analysis findings with OWASP compliance and blockchain-specific enhancements",
  "version": "5.0.0",
  "type": "object",
  "required": [
    "id",
    "severity",
    "title", 
    "category",
    "description",
    "location",
    "recommendation",
    "confidence",
    "ai_metadata"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^FIND-[0-9A-F]{32}$",
      "description": "Unique finding identifier in UUID format with FIND- prefix",
      "examples": ["FIND-12345678-ABCD-EFGH-IJKL-123456789ABC"]
    },
    "severity": {
      "type": "string",
      "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO", "GAS_OPTIMIZATION"],
      "description": "Risk severity level following OWASP classification",
      "examples": ["HIGH"]
    },
    "title": {
      "type": "string",
      "minLength": 20,
      "maxLength": 200,
      "pattern": "^[A-Z][^.]*[^.]$",
      "description": "Descriptive title following pattern: [Vulnerability Type] in [Function/Component] enables/allows [Impact/Consequence]",
      "examples": ["Re-entrancy in withdraw function enables fund drainage through recursive calls"]
    },
    "category": {
      "type": "string",
      "enum": [
        "SWC-107-Reentrancy",
        "SWC-101-Integer Overflow and Underflow", 
        "SWC-115-Authorization through tx.origin",
        "SWC-116-Block values as a proxy for time",
        "SWC-120-Weak Sources of Randomness",
        "A01:2021-Broken Access Control",
        "A02:2021-Cryptographic Failures",
        "A03:2021-Injection",
        "A06:2021-Vulnerable Components",
        "A09:2021-Security Logging Failures",
        "DEFI-001-Oracle Manipulation",
        "DEFI-002-Flash Loan Attack",
        "DEFI-003-Slippage Manipulation",
        "DEFI-004-Liquidity Drain Attack",
        "NFT-001-Metadata Manipulation",
        "NFT-002-Ownership Bypass",
        "GAS-001-Inefficient Storage Access",
        "GAS-002-Loop Optimization",
        "GAS-003-Function Visibility",
        "PROXY-001-Uninitialized Implementation",
        "PROXY-002-Storage Collision",
        "GOVERNANCE-001-Vote Manipulation",
        "CROSS-CHAIN-001-Bridge Vulnerability",
        "CUSTOM-001-Business Logic Flaw"
      ],
      "description": "Security category following SWC, OWASP, or blockchain-specific classification"
    },
    "description": {
      "type": "string",
      "minLength": 50,
      "maxLength": 2000,
      "description": "Detailed technical explanation following 4-part structure: What, Where, How, Impact",
      "examples": ["The withdraw function performs an external call to transfer Ether before updating the user's balance, creating a classic reentrancy vulnerability. An attacker can deploy a malicious contract with a fallback function that recursively calls withdraw() during the external call execution, bypassing the balance check and potentially draining all contract funds."]
    },
    "confidence": {
      "type": "string",
      "enum": ["HIGH", "MEDIUM", "LOW"],
      "description": "AI confidence level in finding accuracy"
    },
    "location": {
      "type": "object",
      "required": ["line", "function", "contract"],
      "properties": {
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Starting line number where vulnerability is located"
        },
        "line_end": {
          "type": "integer",
          "minimum": 1,
          "description": "Ending line number for multi-line vulnerabilities"
        },
        "function": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Function name containing the vulnerability"
        },
        "contract": {
          "type": "string", 
          "minLength": 1,
          "maxLength": 100,
          "description": "Contract name containing the vulnerability"
        },
        "file": {
          "type": "string",
          "description": "File path relative to project root"
        },
        "code_snippet": {
          "type": "string",
          "maxLength": 1000,
          "description": "Relevant vulnerable code excerpt (max 10 lines)"
        },
        "affected_variables": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "State variables affected by the vulnerability"
        },
        "control_flow": {
          "type": "object",
          "properties": {
            "entry_points": {
              "type": "array",
              "items": {"type": "string"}
            },
            "execution_path": {
              "type": "array",
              "items": {"type": "string"}
            },
            "conditions": {
              "type": "array", 
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "recommendation": {
      "type": "object",
      "required": ["immediate_action", "summary", "detailed_steps"],
      "properties": {
        "immediate_action": {
          "type": "string",
          "enum": ["PAUSE_CONTRACT", "PATCH_IMMEDIATELY", "DISABLE_FUNCTION", "MONITOR_CLOSELY", "NO_ACTION"],
          "description": "Recommended immediate response"
        },
        "summary": {
          "type": "string",
          "minLength": 20,
          "maxLength": 500,
          "description": "High-level remediation approach"
        },
        "detailed_steps": {
          "type": "array",
          "minItems": 1,
          "maxItems": 10,
          "items": {
            "type": "object",
            "required": ["step", "action"],
            "properties": {
              "step": {"type": "integer", "minimum": 1},
              "action": {"type": "string", "minLength": 10},
              "code_example": {"type": "string"},
              "verification": {"type": "string"},
              "estimated_effort": {
                "type": "string",
                "enum": ["TRIVIAL", "EASY", "MODERATE", "COMPLEX", "EXTENSIVE"]
              }
            }
          }
        },
        "secure_pattern": {
          "type": "object",
          "properties": {
            "name": {"type": "string"},
            "description": {"type": "string"},
            "implementation": {"type": "string"},
            "references": {
              "type": "array",
              "items": {"type": "string", "format": "uri"}
            }
          }
        },
        "estimated_fix_time": {
          "type": "string",
          "enum": ["MINUTES", "HOURS", "DAYS", "WEEKS"]
        }
      }
    },
    "risk_metrics": {
      "type": "object",
      "properties": {
        "cvss_v3": {
          "type": "object",
          "properties": {
            "score": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 10.0
            },
            "vector": {
              "type": "string",
              "pattern": "^CVSS:3\\.[01]/.+$"
            }
          }
        },
        "exploitability": {
          "type": "object",
          "properties": {
            "ease": {
              "type": "string",
              "enum": ["TRIVIAL", "EASY", "MODERATE", "DIFFICULT", "THEORETICAL"]
            },
            "prerequisites": {
              "type": "array",
              "items": {"type": "string"}
            },
            "attack_complexity": {
              "type": "string", 
              "enum": ["LOW", "MEDIUM", "HIGH"]
            },
            "cost_to_exploit": {
              "type": "string",
              "enum": ["NONE", "LOW", "MEDIUM", "HIGH", "VERY_HIGH"]
            }
          }
        },
        "business_impact": {
          "type": "object",
          "properties": {
            "financial": {
              "type": "object",
              "properties": {
                "direct_loss": {
                  "type": "string",
                  "enum": ["NONE", "LOW", "MEDIUM", "HIGH", "TOTAL"]
                },
                "loss_estimate": {"type": "string"},
                "affected_funds": {
                  "type": "string",
                  "enum": ["USER_FUNDS", "PROTOCOL_FUNDS", "GOVERNANCE_FUNDS", "TREASURY", "LIQUIDITY_POOLS"]
                }
              }
            },
            "operational": {
              "type": "string",
              "enum": ["NONE", "MINIMAL", "MODERATE", "SEVERE", "CRITICAL"]
            },
            "reputation": {
              "type": "string", 
              "enum": ["NONE", "MINIMAL", "MODERATE", "SIGNIFICANT", "CRITICAL"]
            }
          }
        }
      }
    },
    "blockchain_context": {
      "type": "object",
      "properties": {
        "networks": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["ETHEREUM", "POLYGON", "BSC", "ARBITRUM", "OPTIMISM", "AVALANCHE", "FANTOM", "SOLANA", "NEAR", "ALL_EVM"]
          }
        },
        "evm_specifics": {
          "type": "object",
          "properties": {
            "solidity_version": {"type": "string"},
            "optimization_enabled": {"type": "boolean"},
            "optimization_runs": {"type": "integer"},
            "compiler_version": {"type": "string"}
          }
        },
        "gas_analysis": {
          "type": "object",
          "properties": {
            "vulnerability_gas_cost": {"type": "integer"},
            "fix_gas_impact": {"type": "integer"},
            "optimization_potential": {"type": "integer"},
            "gas_limit_risk": {"type": "boolean"}
          }
        },
        "defi_context": {
          "type": "object",
          "properties": {
            "protocol_type": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["AMM", "LENDING", "YIELD_FARMING", "DERIVATIVES", "INSURANCE", "STAKING", "GOVERNANCE", "BRIDGE", "NFT_MARKETPLACE", "LAUNCHPAD"]
              }
            },
            "tvl_impact": {
              "type": "string",
              "enum": ["NONE", "PARTIAL", "SIGNIFICANT", "COMPLETE"]
            },
            "liquidity_risk": {"type": "boolean"},
            "oracle_dependency": {"type": "boolean"},
            "external_dependencies": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "ai_metadata": {
      "type": "object",
      "required": ["model", "analysis_version", "detection_method"],
      "properties": {
        "model": {
          "type": "string",
          "enum": ["gpt-4", "gpt-3.5-turbo", "claude-3", "claude-2", "gemini-pro", "custom-model"],
          "description": "AI model used for analysis"
        },
        "analysis_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Version of the analysis engine"
        },
        "detection_method": {
          "type": "string",
          "enum": ["LLM_ANALYSIS", "STATIC_ANALYSIS", "DYNAMIC_ANALYSIS", "HYBRID", "MANUAL_REVIEW"]
        },
        "prompt_engineering": {
          "type": "object",
          "properties": {
            "prompt_version": {"type": "string"},
            "prompt_type": {"type": "string"},
            "context_window": {"type": "integer"},
            "temperature": {"type": "number", "minimum": 0, "maximum": 2}
          }
        },
        "confidence_scoring": {
          "type": "object",
          "properties": {
            "base_confidence": {"type": "number", "minimum": 0, "maximum": 1},
            "false_positive_probability": {"type": "number", "minimum": 0, "maximum": 1},
            "validation_score": {"type": "number", "minimum": 0, "maximum": 1},
            "contextual_factors": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "factor": {"type": "string"},
                  "impact": {"type": "number"},
                  "weight": {"type": "number"}
                }
              }
            }
          }
        },
        "processing_info": {
          "type": "object",
          "properties": {
            "analysis_time_ms": {"type": "integer"},
            "tokens_used": {"type": "integer"},
            "cost_usd": {"type": "number"},
            "created_at": {"type": "string", "format": "date-time"}
          }
        }
      }
    },
    "attack_vector": {
      "type": "object",
      "properties": {
        "description": {"type": "string"},
        "steps": {
          "type": "array",
          "items": {"type": "string"}
        },
        "prerequisites": {
          "type": "array", 
          "items": {"type": "string"}
        },
        "proof_of_concept": {"type": "string"},
        "mitigation_bypasses": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "related_findings": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "finding_id": {"type": "string"},
          "relationship": {
            "type": "string",
            "enum": ["DUPLICATE", "RELATED", "PREREQUISITE", "CONSEQUENCE", "MITIGATION_CONFLICT"]
          },
          "description": {"type": "string"}
        }
      }
    },
    "compliance": {
      "type": "object",
      "properties": {
        "standards": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["OWASP", "SWC", "CWE", "NIST", "ISO27001", "SOC2", "PCI-DSS"]
          }
        },
        "regulatory_impact": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    },
    "quality_metrics": {
      "type": "object",
      "properties": {
        "completeness_score": {"type": "number", "minimum": 0, "maximum": 100},
        "actionability_score": {"type": "number", "minimum": 0, "maximum": 100},
        "technical_depth_score": {"type": "number", "minimum": 0, "maximum": 100},
        "overall_quality_score": {"type": "number", "minimum": 0, "maximum": 100}
      }
    },
    "status": {
      "type": "string",
      "enum": ["OPEN", "IN_REVIEW", "CONFIRMED", "FALSE_POSITIVE", "ACCEPTED_RISK", "FIXED", "WONT_FIX"],
      "default": "OPEN"
    },
    "tags": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Additional classification tags for filtering and grouping"
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "id": "FIND-12345678-ABCD-EFGH-IJKL-123456789ABC",
      "severity": "HIGH",
      "title": "Re-entrancy in withdraw function enables fund drainage through recursive calls",
      "category": "SWC-107-Reentrancy",
      "description": "The withdraw function performs an external call to transfer Ether before updating the user's balance, creating a classic reentrancy vulnerability. An attacker can deploy a malicious contract with a fallback function that recursively calls withdraw() during the external call execution, bypassing the balance check and potentially draining all contract funds.",
      "confidence": "HIGH",
      "location": {
        "line": 125,
        "line_end": 129,
        "function": "withdraw",
        "contract": "VulnerableBank",
        "code_snippet": "function withdraw(uint amount) public {\n    require(balances[msg.sender] >= amount);\n    msg.sender.call{value: amount}(\"\");\n    balances[msg.sender] -= amount;\n}",
        "affected_variables": ["balances", "amount"]
      },
      "recommendation": {
        "immediate_action": "PATCH_IMMEDIATELY",
        "summary": "Implement checks-effects-interactions pattern with reentrancy guard",
        "detailed_steps": [
          {
            "step": 1,
            "action": "Install OpenZeppelin's ReentrancyGuard contract",
            "code_example": "npm install @openzeppelin/contracts",
            "verification": "Check package.json for dependency",
            "estimated_effort": "TRIVIAL"
          },
          {
            "step": 2,
            "action": "Add nonReentrant modifier to vulnerable functions",
            "code_example": "function withdraw(uint amount) public nonReentrant {",
            "verification": "Function signature includes modifier",
            "estimated_effort": "EASY"
          }
        ],
        "estimated_fix_time": "HOURS"
      },
      "ai_metadata": {
        "model": "gpt-4",
        "analysis_version": "5.0.0",
        "detection_method": "LLM_ANALYSIS",
        "processing_info": {
          "analysis_time_ms": 1500,
          "tokens_used": 2048,
          "created_at": "2024-08-09T05:30:00Z"
        }
      }
    }
  ]
}